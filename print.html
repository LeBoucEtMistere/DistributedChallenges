<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rust Workshop Tutorial: Distributed Systems Challenges</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="00-intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="01-setup.html"><strong aria-hidden="true">1.</strong> Chapter 1: Setup</a></li><li class="chapter-item expanded "><a href="02-basics.html"><strong aria-hidden="true">2.</strong> Chapter 2: Basic knowledge of Rust</a></li><li class="chapter-item expanded "><a href="03-echo.html"><strong aria-hidden="true">3.</strong> Chapter 3: The Echo challenge</a></li><li class="chapter-item expanded "><a href="04-unique_id.html"><strong aria-hidden="true">4.</strong> Chapter 4: The Unique Id challenge</a></li><li class="chapter-item expanded affix "><a href="A-cargo.html">Appendix A: Cargo Cheatsheet</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Workshop Tutorial: Distributed Systems Challenges</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>This tutorial will walk you through solving Fly.io distributed challenges in Rust: https://fly.io/dist-sys/</p>
<p>This is intended as an entry-level content to discover Rust, hopefully easily approachable by complete Rust beginners.</p>
<p>The <a href="https://github.com/LeBoucEtMistere/DistributedChallenges">repo</a> structure is the following:</p>
<ul>
<li>The folder <a href="https://github.com/LeBoucEtMistere/DistributedChallenges/tree/main/distributed_challenges_solution">distributes_challenges_solution</a> contains a rust project with the full solution</li>
<li>The folder <a href="https://github.com/LeBoucEtMistere/DistributedChallenges/tree/main/distributed_challenges">distributes_challenges</a> contains the initial template to start the workshop </li>
<li>The folder <a href="https://github.com/LeBoucEtMistere/DistributedChallenges/tree/main/tutorial">tutorial</a> contains the sources of this book.</li>
<li>The folder <a href="https://github.com/LeBoucEtMistere/DistributedChallenges/tree/main/node_driver">node_driver</a> contains a library that handles all the things related to communication with Maelstrom in rust, that your solution shall depend on.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-1-setup"><a class="header" href="#chapter-1-setup">Chapter 1: Setup</a></h1>
<p>In this first chapter, we will see how to setup a Rust toolchain from scratch, an IDE to develop Rust, and the Maelstrom testbench that we will use to evaluate your solutions to the various Distributed System challenges.</p>
<h2 id="rust-setup"><a class="header" href="#rust-setup">Rust setup</a></h2>
<h3 id="install-rust-toolchain"><a class="header" href="#install-rust-toolchain">Install Rust toolchain</a></h3>
<p>Rust is installed through <code>rustup</code>, an utility which manages your rust toolchain (like <code>nvm</code> for node for instance). Install it with: </p>
<pre><code class="language-bash">curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
</code></pre>
<p>This repo builds on the latest stable version of Rust, <code>Rust 1.68</code>.
When installing rustup, it will prompt you to install the latest stable Rust version. If you already have rust installed, run <code>rustup upgrade</code> to get the lastest version.</p>
<p>Note that as stated by the installer, you will need to export an env variable in your shell .rc file after the install process, and restart your shell to pick it up.</p>
<p>You can sanity check your installation by running <code>cargo --version</code>, more on cargo later.</p>
<p>You will also need to install the MacOS vendored LLVM compiler (it's possible you already have it, but it tends to disappear after a major MacOS upgrade): run <code>xcode-select install</code>.</p>
<h3 id="setting-up-ide"><a class="header" href="#setting-up-ide">Setting up IDE</a></h3>
<p>I recommend VSCode for the easiest dev experience possible. We will configure it to leverage <code>rust-analyzer</code>, the official LSP server for Rust, <code>clippy</code> the official linter for Rust and <code>rustfmt</code> the official formatter for Rust.</p>
<p>Note that both <code>rustfmt</code> and <code>clippy</code> ship with the default Rust toolchain install so you don't have to do anything to get them.</p>
<p>To get <code>rust-analyzer</code>, we will install the VSCode integration called <code>rust-lang.rust-analyzer</code>. This extension will handle itself the process of downloading the binaries for <code>rust-analyzer</code> transparently.</p>
<p>I then recommand to alter your VSCode config (<code>Cmd+,</code>) and add the following keys:</p>
<pre><code class="language-json">{
    &quot;editor.formatOnSave&quot;: true,
    &quot;rust-analyzer.checkOnSave.command&quot;: &quot;clippy&quot;,
}
</code></pre>
<p>Here are some other additional extensions that will make your developper experience smoother:</p>
<ul>
<li><code>serayuzgur.crates</code> Augmented functionalities to manage the crates used in your project</li>
<li><code>tamasfe.even-better-toml</code> LSP for the TOML language which is often used with Rust</li>
<li><code>usernamehw.errorlens</code> Inline errors in your code, making it easier to see them in context</li>
</ul>
<h3 id="optional-installing-a-nightly-toolchain-for-nicer-formatting"><a class="header" href="#optional-installing-a-nightly-toolchain-for-nicer-formatting">Optional: installing a nightly toolchain for nicer formatting</a></h3>
<p>Some nice formatting options for your code are gated behind the nightly toolchain of Rust. In particular, the option to sort imports by type (std,3p,prj for instance). To get this, we can install the latest nightly toolchain using rustup (<code>rustup toolchain install nightly</code>). Then add the following in your vscode config file:</p>
<pre><code class="language-json">{
    &quot;rust-analyzer.rustfmt.extraArgs&quot;: [
        &quot;+nightly&quot;
    ],
}
</code></pre>
<p>This will force the usage of the formatter coming with the nightly toolchain (this does not mean your project will be compiled with the nightly toolchain though, only the formatter will use it).</p>
<p>Then, you can specify a <code>.rustfmt.toml</code> file at the root of your project with this content:</p>
<pre><code class="language-toml">group_imports = &quot;StdExternalCrate&quot;
</code></pre>
<h2 id="maelstrom-setup"><a class="header" href="#maelstrom-setup">Maelstrom setup</a></h2>
<p>The challenges we will solve are built on top of a platform called <a href="https://github.com/jepsen-io/maelstrom">Maelstrom</a>. This platform lets you build out a &quot;node&quot; in your distributed system and Maelstrom will handle the routing of messages between the those nodes. This lets Maelstrom inject failures and perform verification checks based on the consistency guarantees required by each challenge. You can see it as a simulator and test bench for developping distributed systems.</p>
<p>Maelstrom is built in Clojure and therefore requires the Java JDK to run. It also provides some plotting and graphing utilities which rely on Graphviz &amp; gnuplot. You can install all the required dependencies with this command:</p>
<pre><code class="language-bash">brew install openjdk graphviz gnuplot
</code></pre>
<p>You will need to tell your system about this java version by running</p>
<pre><code class="language-bash">sudo ln -sfn /opt/homebrew/opt/openjdk/libexec/openjdk.jdk /Library/Java/JavaVirtualMachines/openjdk.jdk
</code></pre>
<p>We are now ready to download Maelstrom binary, the following commands will install it under <code>~/maelstrom/maelstrom</code>:</p>
<pre><code class="language-bash">curl -L https://github.com/jepsen-io/maelstrom/releases/download/v0.2.3/maelstrom.tar.bz2 &gt; /tmp/maelstrom.tar.bz2
tar -C ~/ -xvf /tmp/maelstrom.tar.bz2
rm -rf /tmp/maelstrom.tar.bz2
</code></pre>
<p>Each problem will come with a set of Maelstrom commands to run it and test it so you don't have to worry on understanding all the parameters you can pass to the CLI.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-2-basic-knowledge-of-rust"><a class="header" href="#chapter-2-basic-knowledge-of-rust">Chapter 2: Basic knowledge of Rust</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-3-the-echo-challenge"><a class="header" href="#chapter-3-the-echo-challenge">Chapter 3: The Echo challenge</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-4-the-unique-id-challenge"><a class="header" href="#chapter-4-the-unique-id-challenge">Chapter 4: The Unique Id challenge</a></h1>
<h2 id="explanation"><a class="header" href="#explanation">Explanation</a></h2>
<p>You can find the challenge here: <a href="https://fly.io/dist-sys/1/">https://fly.io/dist-sys/1/</a></p>
<p>The goal of this challenge is to generate unique ids across several nodes. There are two approaches to this solution:</p>
<ul>
<li>let the nodes communicate between them to sync (complex)</li>
<li>generate ids with enough entropy to avoid collisions between two generation no matter the node (easy)</li>
</ul>
<p>We will follow the second approach and rely on <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUIDs</a> generation algorithms, and more specifically UUIDs V4.</p>
<h2 id="walkthrough"><a class="header" href="#walkthrough">Walkthrough</a></h2>
<p>The code will be very similar to the Echo challenge code, so feel free to copy and paste and try it by yourself if you want, the only new concepts will be around importing a library (a crate in rust lingua) to our project, but other than this, you already have all the knowledge to do it by yourself.</p>
<p>Let's start by defining the messages we want to receive and send, based on the description provided by the challenge:
We have a Generate request with the following body</p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;generate&quot;
}
</code></pre>
<p>and a GenerateOk response with the following body:</p>
<pre><code class="language-json">{
  &quot;type&quot;: &quot;generate_ok&quot;,
  &quot;id&quot;: &quot;123&quot;
}
</code></pre>
<p>(note the id can be of any type but we will stick with a string here since that's what UUIDs use)</p>
<p>Therefore, we will write the following enum to describe the payloads our application can deal with:</p>
<pre><code class="language-rust ignore">#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(tag = &quot;type&quot;)]
#[serde(rename_all = &quot;snake_case&quot;)]
enum UniqueIdPayload {
    /// Used by clients to send a generate request
    Generate,
    /// Used by nodes to respond to a generate request, we use a string typed ID since we
    /// will return uuid-v4
    GenerateOk { id: String },
}</code></pre>
<p>As in the previous part, you can note the various annotations on the enum to derive the common basic traits <code>Debug</code> and <code>Clone</code>, and the traits related to ser/de <code>Serialize</code> and <code>Deserialize</code>. These generate all the base scaffolding code under the hood to enable this enum variants to be easily displayed, cloned, serialized and deserialized (to json in particular which is what we care for here). There also are <code>serde</code> relative annotations to internally tag the enum variants with a type field, and rename all variants to a snake_case format. This basically gives us the required <code>type = </code> field in the json payload.</p>
<p>We have two variants, Generate representing generate requests, which doesn't contain any data, and GenerateOk representing a response to this request, that contains a field named <code>id</code> of type String.</p>
<p>As in the previous part, this paylaod enum is made to be inserted in the payload field of the <code>Message</code> type provided by the <code>node_driver</code> lib.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="appendix-a-cargo-cheatsheet"><a class="header" href="#appendix-a-cargo-cheatsheet">Appendix A: Cargo Cheatsheet</a></h1>
<p><code>cargo</code> is the main interface with rust you will use. This is a CLI tool that exposes all commands to check, build, format, and release your code, and that handles interacting with the compiler <code>rustc</code> for you. Think of it as <code>poetry</code> for python or <code>npm</code> for node.</p>
<p>Here is a quick cheatsheet of useful commands:</p>
<pre><code class="language-bash">cargo build # build a debug binary/lib
cargo run # build and run a debug binary/lib
cargo {build|run} --release # same but for release binary/lib

cargo test # run all tests of your project
cargo doc # build a static website serving the documentation of your project

cargo check # check correctness of your code, i.e. does it compile ?
cargo fmt # run the formatter on your code
cargo clippy # run the linter on your code, note that this is a superset of cargo check

cargo add &lt;crate_name&gt; # add a crate to your project, i.e. a dependency
cargo remove &lt;crate_name&gt; # remove a crate from your project
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
